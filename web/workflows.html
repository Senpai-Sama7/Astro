<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Astro Workflow Builder</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; background: #0f0f1a; color: #e0e0e0; margin: 0; padding: 20px; }
    h1 { color: #3282b8; margin-bottom: 20px; }
    .container { display: grid; grid-template-columns: 300px 1fr; gap: 20px; max-width: 1400px; margin: 0 auto; }
    .panel { background: #1a1a2e; border-radius: 12px; padding: 20px; }
    .panel h2 { margin-top: 0; color: #0f4c75; font-size: 1.2em; }
    .workflow-list { list-style: none; padding: 0; margin: 0; }
    .workflow-list li { padding: 12px; background: #16213e; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: background 0.2s; }
    .workflow-list li:hover { background: #1f3460; }
    .workflow-list li.active { background: #3282b8; }
    .btn { background: #3282b8; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .btn:hover { background: #0f4c75; }
    .btn-danger { background: #e74c3c; }
    .btn-success { background: #27ae60; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; color: #888; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; background: #16213e; border: 1px solid #333; border-radius: 6px; color: #e0e0e0; }
    .form-group textarea { min-height: 100px; resize: vertical; }
    .steps-container { margin-top: 20px; }
    .step { background: #16213e; border-radius: 8px; padding: 15px; margin-bottom: 10px; position: relative; }
    .step-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .step-number { background: #3282b8; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
    .remove-step { background: none; border: none; color: #e74c3c; cursor: pointer; font-size: 18px; }
    .results { background: #16213e; border-radius: 8px; padding: 15px; margin-top: 20px; max-height: 300px; overflow-y: auto; }
    .results pre { margin: 0; white-space: pre-wrap; font-size: 12px; }
    .tools-list { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px; }
    .tool-tag { background: #0f4c75; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer; }
    .tool-tag:hover { background: #3282b8; }
    .empty-state { text-align: center; color: #666; padding: 40px; }
  </style>
</head>
<body>
  <h1>üîÑ Astro Workflow Builder</h1>
  <div class="container">
    <div class="panel">
      <h2>Workflows</h2>
      <button class="btn" onclick="newWorkflow()" style="width: 100%; margin-bottom: 15px;">+ New Workflow</button>
      <ul class="workflow-list" id="workflowList"></ul>
    </div>
    <div class="panel">
      <div id="editor" style="display: none;">
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="wfName" placeholder="My Workflow">
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="wfDesc" placeholder="What does this workflow do?"></textarea>
        </div>
        <h3>Available Tools</h3>
        <div class="tools-list" id="toolsList"></div>
        <h3>Steps</h3>
        <div class="steps-container" id="stepsContainer"></div>
        <button class="btn" onclick="addStep()">+ Add Step</button>
        <div style="margin-top: 20px; display: flex; gap: 10px;">
          <button class="btn btn-success" onclick="saveWorkflow()">üíæ Save</button>
          <button class="btn" onclick="executeWorkflow()">‚ñ∂Ô∏è Execute</button>
          <button class="btn btn-danger" onclick="deleteWorkflow()">üóëÔ∏è Delete</button>
        </div>
        <div class="results" id="results" style="display: none;">
          <h4>Execution Results</h4>
          <pre id="resultsContent"></pre>
        </div>
      </div>
      <div id="emptyState" class="empty-state">
        <p>Select a workflow or create a new one</p>
      </div>
    </div>
  </div>

  <script>
    const API = '/api/v1';
    let workflows = [];
    let tools = [];
    let currentWorkflow = null;
    let steps = [];

    async function init() {
      await loadTools();
      await loadWorkflows();
    }

    async function loadTools() {
      try {
        const res = await fetch(`${API}/astro/tools`);
        tools = await res.json();
        renderTools();
      } catch (e) { console.error('Failed to load tools:', e); }
    }

    async function loadWorkflows() {
      try {
        const res = await fetch(`${API}/workflows`);
        workflows = await res.json();
        renderWorkflowList();
      } catch (e) { console.error('Failed to load workflows:', e); }
    }

    function renderTools() {
      const container = document.getElementById('toolsList');
      container.innerHTML = tools.map(t => 
        `<span class="tool-tag" onclick="addStepWithTool('${t.name}')" title="${t.description}">${t.name}</span>`
      ).join('');
    }

    function renderWorkflowList() {
      const list = document.getElementById('workflowList');
      list.innerHTML = workflows.map(w => 
        `<li onclick="selectWorkflow('${w.id}')" class="${currentWorkflow?.id === w.id ? 'active' : ''}">${w.name}</li>`
      ).join('') || '<li style="color: #666;">No workflows yet</li>';
    }

    function newWorkflow() {
      currentWorkflow = null;
      steps = [];
      document.getElementById('wfName').value = '';
      document.getElementById('wfDesc').value = '';
      document.getElementById('editor').style.display = 'block';
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('results').style.display = 'none';
      renderSteps();
      renderWorkflowList();
    }

    function selectWorkflow(id) {
      currentWorkflow = workflows.find(w => w.id === id);
      if (!currentWorkflow) return;
      steps = [...currentWorkflow.steps];
      document.getElementById('wfName').value = currentWorkflow.name;
      document.getElementById('wfDesc').value = currentWorkflow.description;
      document.getElementById('editor').style.display = 'block';
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('results').style.display = 'none';
      renderSteps();
      renderWorkflowList();
    }

    function addStep() {
      steps.push({ id: `step_${Date.now()}`, tool: tools[0]?.name || '', input: {}, dependsOn: [] });
      renderSteps();
    }

    function addStepWithTool(toolName) {
      steps.push({ id: `step_${Date.now()}`, tool: toolName, input: {}, dependsOn: [] });
      renderSteps();
    }

    function removeStep(index) {
      steps.splice(index, 1);
      renderSteps();
    }

    function renderSteps() {
      const container = document.getElementById('stepsContainer');
      container.innerHTML = steps.map((step, i) => `
        <div class="step">
          <div class="step-header">
            <span class="step-number">${i + 1}</span>
            <button class="remove-step" onclick="removeStep(${i})">√ó</button>
          </div>
          <div class="form-group">
            <label>Step ID</label>
            <input type="text" value="${step.id}" onchange="steps[${i}].id = this.value">
          </div>
          <div class="form-group">
            <label>Tool</label>
            <select onchange="steps[${i}].tool = this.value">
              ${tools.map(t => `<option value="${t.name}" ${t.name === step.tool ? 'selected' : ''}>${t.name}</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label>Input (JSON)</label>
            <textarea onchange="try { steps[${i}].input = JSON.parse(this.value) } catch {}">${JSON.stringify(step.input, null, 2)}</textarea>
          </div>
          <div class="form-group">
            <label>Depends On (comma-separated step IDs)</label>
            <input type="text" value="${(step.dependsOn || []).join(', ')}" onchange="steps[${i}].dependsOn = this.value.split(',').map(s => s.trim()).filter(Boolean)">
          </div>
        </div>
      `).join('') || '<p style="color: #666;">No steps yet. Add a step or click a tool above.</p>';
    }

    async function saveWorkflow() {
      const name = document.getElementById('wfName').value;
      const description = document.getElementById('wfDesc').value;
      if (!name) return alert('Name is required');

      const data = { name, description, steps };
      try {
        let res;
        if (currentWorkflow) {
          res = await fetch(`${API}/workflows/${currentWorkflow.id}`, {
            method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
          });
        } else {
          res = await fetch(`${API}/workflows`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
          });
        }
        const saved = await res.json();
        currentWorkflow = saved;
        await loadWorkflows();
        alert('Workflow saved!');
      } catch (e) { alert('Failed to save: ' + e); }
    }

    async function executeWorkflow() {
      if (!currentWorkflow) return alert('Save workflow first');
      document.getElementById('results').style.display = 'block';
      document.getElementById('resultsContent').textContent = 'Executing...';
      try {
        const res = await fetch(`${API}/workflows/${currentWorkflow.id}/execute`, { method: 'POST' });
        const data = await res.json();
        document.getElementById('resultsContent').textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        document.getElementById('resultsContent').textContent = 'Error: ' + e;
      }
    }

    async function deleteWorkflow() {
      if (!currentWorkflow) return;
      if (!confirm('Delete this workflow?')) return;
      try {
        await fetch(`${API}/workflows/${currentWorkflow.id}`, { method: 'DELETE' });
        currentWorkflow = null;
        steps = [];
        document.getElementById('editor').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        await loadWorkflows();
      } catch (e) { alert('Failed to delete: ' + e); }
    }

    init();
  </script>
</body>
</html>
